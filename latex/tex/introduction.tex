\section{Introduction}
The dynamic delivery of a given fluence map by a multi-leaf collimator (MLC) remains a difficult, largely unsolved problem.
The sliding-window leaf-sweep algorithm (SWLS) \cite{leafsweep}, 
    in which the MLC leaves cross the treatment field in a unidirectional fashion, 
    achieves perfect fluence map replication if sufficient time is available \cite{Stein94}.
However, the SWLS algorithm does not have to be efficient with respect to the required delivery time.
Time is an important aspect of VMAT and IMRT treatment plans, for several reasons:
\begin{enumerate}[i)]
  \item The effect of patient movement on delivery inaccuracy increases in the time the patient is exposed to radiation.
  \item Shorter treatments allow the treatment facility to help more patients on a given set of radiation therapy machines, 
        which is particularly relevant to third-world countries as these machines are expensive.
  \item $\hdots$
\end{enumerate}
Several studies have investigated the trade-off between treatment time and plan quality \cite{tradeoffSalari,tradeoffMCO,tradeoffCraft}.
\cite{balvertcraft} were the first to include treatment time in the leaf sequencing step of the treatment plan optimization challenge.
They construct the trade-off curve between delivery time and fluence map matching accuracy by optimizing leaf trajectories and dose rate patterns for a sequence of delivery times.
% for several leaf trajectories independently
For a given fluence map and fixed delivery time, the challenge of optimizing the leaf trajectories and dose rate versus time so that the given fluence map is matched as accurately as possible, subject to machine restrictions, presents a large scale nonconvex optimization problem.
The nonconvexity of the fluence map matching problem leads to a large number of local minima.
For a thorough introduction to the complexities of dynamic fluence map delivery (which generally arises in the context of volumetric modulated arc therapy, VMAT),
 see \cite{balvertcraft} and \cite{unkvmatreview}.

%% Previously (until 22/08)
%The optimal dynamic delivery of a given fluence map remains a difficult,
%largely unsolved problem, due to its inherent nonconvexity.
%The nonconvexity of the fluence map matching problem leads to a large number of local minima.
%Many methods simply ignore this crucial aspect of the problem,
%and others use a multi-start procedure to find several local minima and return the best one found.
%For a thorough introduction to the complexities of dynamic fluence map delivery
%(which generally arises in the context of volumetric modulated arc therapy, VMAT),
%see \cite{balvertcraft} and \cite{unkvmatreview}.

\cite{balvertcraft} developed a local search heuristic that initiates a gradient-informed interior point method from multiple, feasible starting solutions and returns the best local optimum found.
Their approach leads to high quality solutions but is clinically infeasible due to large computation times.
Like others, they represent the leaf trajectories and the dose rate pattern by discretizing the time domain:
at several moments in time (also called control points), the positions of all leaf ends and the dose rate level is specified.
The achieved precision is controlled by the amount of time that elapses between two adjacent control points.

\cite{balvertcraft} and \cite{thesisKvA} % dependent on publishing date
observed that the best found leaf trajectories and dose rate patterns are `smooth' in the sense that the leaves move across the field in a near-unidirectional fashion and that the dose rate pattern features only several ups and downs. %drops and rises
In this technical note, we investigate a regularization procedure that exploits this smoothness property by representing leaf trajectories and the dose rate pattern by low-order polynomial splines.
\footnote{A polynomial spline is a function that is formed by a sequence of polynomial segments.}
For that, we make use of methods that are widely used in the field of trajectory control.
For an overview of such methods, see \addref{Trajectory control}.
\KvAcomment{Matthew, do you know a good paper/survey that explains or illustrates some of these methods?}
The idea is that by representing leaf trajectories as low-order polynomials and optimizing over their coefficients, the size of the solution space can be significantly reduced.

\todo{Integrate focus (leaf trajectories, dose rate pattern, no jaws), assumptions (no interdigitation, no tongue-and-groove effect) and constraints (maxDose, maxLeafSpeed).}

%%% Previously (until 22/08)
%In this technical note, we investigate a regularization procedure which represents
%leaf trajectories and dose rates as linear splines (piece-wise linear functions),
%such that the optimization procedure naturally focuses on global aspects of the leaf trajectory/dose rate solution.

\todo{ David  --  Would you be able to add any background that is appropriate for this paper,
at least from a fluence mapping perspective?  Let me know if I should add a short section about
trajectory optimization. Also, should background be its own section, or is a sub-section in the
Introduction acceptable?}
\KvAcomment{20/08: Did I forget to send my contribution to the introduction from quite a while ago as a pull request?
            Edit 22/08: Recovered the intro. Doesn't suite perfectly anymore, but provides some base. Mostly literature review.}

\subsection{Fluence Mapping as Continuous Optimization}
\label{sec:FluenceMappingAsContinuousOptimization}

Our goal is to compute the optimal leaf trajectories $x_L(t)$ and $x_R(t)$,
as well as the optimal dose rate $d(t)$ of the radiation source for $t\in[0,T]$.
For this initial study we will consider only a single leaf pair,
although our algorithm is structured such that it could be applied to an arbitrary number of leaf pairs.
We will assume that adjacent leaves are independent of each other,
neglecting the small coupling terms created by the tongue-and-groove mechanism on the real machine.

Let the position domain of the fluence profile be denoted by $X$.
We will assume that the target fluence at each floating point position $x\in X$, $f(x)$, is given.
Our goal is to find the leaf trajectories $x_L(t)$ and $x_R(t)$ and dose rate pattern $d(t)$
that minimize the squared integral error between the target fluence $f(x)$ and the delivered fluence $g(x)$:

\begin{equation}
\underset{d(t), \, x_L(t), \, x_R(t)}{\operatorname{argmin}}
\int_X \bigg(f(x)) - g(x)\bigg)^2 dx .
\label{eqn:fluenceMapOptimization}
\end{equation}

\vspace{6pt}

\todo{In practice, target fluence comes in discrete format, bixels. How to proceed on fixing this mismatch?
David, is there any chance FMO might give us continuous - or at least very precise - maps in the near future?}

The fluence delivered at each position, $g(x)$, is the time-integral of the dose rate for the times that position is exposed.
This time domain $\mathcal{T}(x)$ is the set of times when the position $x$ is not blocked by either of the leaves, i.e.,
$\mathcal{T}(x)$ is the set of all times $t$ such that $x_L(t) < x \leq x_R(t)$,
as illustrated by Figure \ref{fig:administeredDose} .

\begin{equation}
g(x) = \int_{\mathcal{T}(x)} d(t) dt
\label{eqn:deliveredFluenceDose}
\end{equation}

\input{fig/administeredDose}

For this work we will leave the initial and final leaf positions as decision variables in the optimization,
but it is a trivial extension to enforce arbitrary initial and final leaf positions
with a simple modification to the position limits at these points in the trajectory.
This might be useful when combining a sequence of fluence maps as shown in \cite{balvertcraft}.

We will also assume that the available delivery time is given,
but this could easily be added as a decision variable at a later time.

% $x_L(0) = x_U(0)$ and
% $x_L(t) = x_U(T)$ where
% $t \in [0, T]$.


\subsection{Implementation as a Nested Optimization}

The optimization formulation presented in Section \S \ref{sec:FluenceMappingAsContinuousOptimization}
is a good mathematical description of our goal, but it is not obvious how to solve it.
In this paper we use a nested optimization approach,
solving the dose rate trajectory $d(t)$ in an outer optimization,
and then solving the optimal leaf trajectories $x_L(t)$ and $x_R(t)$ as an inner optimization,
given a candidate dose rate trajectory.

Partitioning the problem in this fashion makes physical sense: given a fixed dose rate trajectory,
the leaf trajectories are completely independent.
This decoupling allows us to focus on designing the inner and outer optimizations differently,
each specialized for the details of that optimization.

\todo{David - do we need an equation here?
    If so, I'm not sure of the best way to write the nested optimization.}

\KvAcomment{I'd formally formulate the inner and outer dose rate optimization problems, with objective and constraints and explaining which entities are variable and which operate as a parameter.}



