\section{Introduction}
The dynamic delivery of a given fluence map by a multi-leaf collimator (MLC) remains a difficult, largely unsolved problem.
The sliding-window leaf-sweep algorithm (SWLS) \cite{leafsweep}, in which the MLC leaves cross the treatment field in a unidirectional fashion, achieves perfect fluence map replication if sufficient time is available \cite{Stein94}.
However, the SWLS algorithm does not have to be efficient with respect to required delivery time.
Time is an important aspect of VMAT and IMRT treatment plans, for several reasons:
\begin{enumerate}[i)]
  \item The effect of patient movement on delivery inaccuracy increases in the time the patient is exposed to radiation.
  \item Shorter treatments allow the treatment facility to help more patients on a given set of radiation therapy machines, which is particularly relevant to third-world countries as these machines are expensive.
  \item $\hdots$
\end{enumerate}
Several studies have investigated the trade-off between treatment time and plan quality \cite{tradeoffSalari,tradeoffMCO,tradeoffCraft}.
\cite{balvertcraft} were the first to include treatment time in the leaf sequencing step of the treatment plan optimization challenge.
They construct the trade-off curve between delivery time and fluence map matching accuracy by optimizing leaf trajectories and dose rate patterns for a sequence of delivery times.
% for several leaf trajectories independently
For a given fluence map and fixed delivery time, the challenge of optimizing the leaf trajectories and dose rate versus time so that the given fluence map is matched as accurately as possible, subject to machine restrictions, presents a large scale nonconvex optimization problem.
The nonconvexity of the fluence map matching problem leads to a large number of local minima.
For a thorough introduction to the complexities of dynamic fluence map delivery (which generally arises in the context of volumetric modulated arc therapy, VMAT),
see \cite{balvertcraft} and \cite{unkvmatreview}.

\cite{balvertcraft} developed a local search heuristic that initiates a gradient-informed interior point method from multiple, feasible starting solutions and returns the best local optimum found.
Their approach leads to high quality solutions but is clinically infeasible due to large computation times.
Like others, they represent the leaf trajectories and the dose rate pattern by discretizing the time domain:
at several moments in time (also called control points), the positions of all leaf ends and the dose rate level is specified.
The achieved precision is controlled by the amount of time that elapses between two adjacent control points.

\cite{balvertcraft} and \addref{Koos' thesis} % dependent on publishing date
observed that the best found leaf trajectories and dose rate patterns are `smooth' in the sense that the leaves move across the field in a near-unidirectional fashion and that the dose rate pattern features only several ups and downs. %drops and rises
In this technical note, we investigate a regularization procedure that exploits this smoothness property by representing leaf trajectories and the dose rate pattern by low-order polynomial splines. 
\footnote{A polynomial spline is a function that is formed by a sequence of polynomial segments.}
For that, we make use of methods that are widely used in the field of trajectory control. 
For an overview of such methods, see \addref{Trajectory control}.
\KvAcomment{Matthew, do you know a good paper that explains or illustrates some of these methods?}
The idea is that by representing leaf trajectories as low-order polynomials and optimizing over their coefficients, the size of the solution space can be significantly reduced.

% Previously (until '17/06/18)
%The optimal dynamic delivery of a given fluence map remains a difficult, largely unsolved problem, due to its inherent nonconvexity.
%The nonconvexity of the fluence map matching problem leads to a large number of local minima.
%Many methods simply ignore this crucial aspect of the problem, and others use a multi-start procedure to find several local minima and return the best one found.
%For a thorough introduction to the complexities of dynamic fluence map delivery (which generally arises in the context of volumetric modulated arc therapy, VMAT),
%see \cite{balvertcraft} and \cite{unkvmatreview}.
%In this technical note, we investigate a regularization procedure which represents leaf trajectories and dose rates as low-order polynomial splines\footnotemark,
%such that the optimization procedure naturally focuses on global aspects of the leaf trajectory/dose rate solution.
%
%\footnotetext{A polynomial spline is a function that is formed by a sequence of polynomial segments.}

\todo{Integrate focus (leaf trajectories, dose rate pattern, no jaws), assumptions (no interdigitation) and constraints (maxDose, maxLeafSpeed).}
\todo{Consider one pair only, easily extendable to multiple pairs (assuming no tongue-and-groove effect)}

\subsection{Testing Figures}

\MPKcomment{Koos: I put this section in to make sure that I could get the test figures to compile in the main document.
            I'm not sure where they are actually supposed to go.}
\KvAcomment{In the administered dose function, I have now illustrated the dose administered to a position x.
A minibixel is just an interval, so the dose delivered to a certain minibixel is just the integral of administered dose over that interval.
The figure assumes that leaves start and end at the same position, $s$ and $e$, respectively. It basically illustrates (\ref{eqn:deliveredFluenceDose}).}

\input{fig/administeredDose}

In this section we have a figure about administered dose \ref{fig:administeredDose}.

\subsection{Fluence Mapping as Continuous Optimization}

Our goal is to compute the optimal leaf trajectories $x_L(t)$ and $x_U(t)$, as well as the optimal dose rate $r(t)$ of the radiation source.
For this initial study we will consider only a single leaf pair, although our algorithm is structured such that it could be applied to an arbitrary number of leaf pairs.

\MPKcomment{What does the following mean?  {\em REMARK: assuming independence of rows, so no tongue-and-groove effect.}}
\KvAcomment{The leaves are coupled using a so called tongue-and-groove system.
If the ends of two adjacent left (or right) leaves are at different positions, the tongue of one of the leaves blocks out a part of field of the other leaf pair, leading to underdosage in that row.
We need to neglect the tongue-and-groove effect to be able to optimize the delivery of every fluence row independently.
Minor thing, but should be noted.}

We will assume that the desired fluence dose at each point $q(x)$ on the subject is given.
The optimization is given below, where $q'(x)$ is the fluence dose that is delivered by the
dose rate and leaf trajectories and $X$ is the position domain of the fluence map.

\begin{equation}
\underset{r(t), \, x_L(t), \, x_U(t)}{\operatorname{argmin}}
\int_X \bigg(q'(x)) - q(x)\bigg)^2 dx
\label{eqn:fluenceMapOptimization}
\end{equation}

The fluence dose at each location can be computed as

\begin{equation}
q'(x) = \int_{T(x)} r(t) dt
\label{eqn:deliveredFluenceDose}
\end{equation}

where $T(x)$ is the set of times when the position $x$ is not blocked by the leaves:
$T(x)$ is the set of all times $t$ such that $ x_L(t) < x < x_U(t)$.


% We will also assume that the leaves start next to each other:
% $x_L(0) = x_U(0)$ and
% $x_L(T) = x_U(T)$ where
% $t \in [0, T]$.

\MPKcomment{Should we assume that the leaf boundary conditions are known?
            Do the leaves need to start and end together?}
\KvAcomment{Matthew: Do you mean boundaries on the physical location of the leaves?
            If so, we can assume that both leaf ends will stay within the treatment field (so if the fluence profile is given on [a,b], the leaves should stay right of a and left of b).
            It can be suboptimal to start the leaves together, but I'm not sure if we should care too much in this project.
            David, what do you think?}
